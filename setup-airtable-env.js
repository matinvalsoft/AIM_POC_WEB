#!/usr/bin/env node

/**
 * Airtable Environment Setup Script
 * Run with: node setup-airtable-env.js
 */

const fs = require('fs');
const path = require('path');
const readline = require('readline');

const ENV_TEMPLATE = `# Airtable Integration Environment Variables
# Generated by setup-airtable-env.js

# ==============================================================================
# REQUIRED VARIABLES
# ==============================================================================

# Your Airtable Personal Access Token (PAT)
# Get from: https://airtable.com/create/tokens
# Required scopes: data.records:read, data.records:write
AIRTABLE_PAT={{PAT}}

# ==============================================================================
# OPTIONAL VARIABLES  
# ==============================================================================

# Default Airtable Base ID (can also be provided via API calls)
# Format: appXXXXXXXXXXXXXX
# Find this in your Airtable base URL: https://airtable.com/appXXXXXXXXXXXXXX/...
AIRTABLE_BASE_ID={{BASE_ID}}

# ==============================================================================
# WEBHOOK CONFIGURATION (Optional)
# ==============================================================================

# Webhook secret for signature verification
# This is provided when you create a webhook subscription
# AIRTABLE_WEBHOOK_SECRET=your_webhook_secret_here

# ==============================================================================
# OAUTH CONFIGURATION (Optional - for multi-tenant apps)
# ==============================================================================

# OAuth Client ID from your Airtable OAuth app
# AIRTABLE_CLIENT_ID=your_oauth_client_id_here

# OAuth Client Secret from your Airtable OAuth app
# AIRTABLE_CLIENT_SECRET=your_oauth_client_secret_here

# OAuth Redirect URI (must match what's configured in Airtable)
# AIRTABLE_REDIRECT_URI=http://localhost:3000/api/airtable/oauth/callback

# ==============================================================================
# PERFORMANCE TUNING (Optional)
# ==============================================================================

# Rate limiting per base (default: 5 requests per second)
AIRTABLE_RATE_LIMIT_PER_BASE=5

# Rate limiting per token (default: 50 requests per second)  
AIRTABLE_RATE_LIMIT_PER_TOKEN=50

# Enable in-memory caching for schema lookups (default: true)
AIRTABLE_ENABLE_CACHE=true

# Cache TTL in seconds (default: 300 = 5 minutes)
AIRTABLE_CACHE_TTL=300
`;

const rl = readline.createInterface({
  input: process.stdin,
  output: process.stdout
});

function question(prompt) {
  return new Promise((resolve) => {
    rl.question(prompt, resolve);
  });
}

async function main() {
  console.log('üöÄ Airtable Integration Setup');
  console.log('=====================================\n');
  
  console.log('This script will help you create a .env.local file with your Airtable credentials.\n');
  
  // Check if .env.local already exists
  const envPath = path.join(process.cwd(), '.env.local');
  if (fs.existsSync(envPath)) {
    console.log('‚ö†Ô∏è  .env.local already exists!');
    const overwrite = await question('Do you want to overwrite it? (y/N): ');
    if (overwrite.toLowerCase() !== 'y' && overwrite.toLowerCase() !== 'yes') {
      console.log('Setup cancelled.');
      rl.close();
      return;
    }
  }

  console.log('\nüìã Let\'s collect your Airtable credentials:\n');

  // Get PAT
  console.log('1. Personal Access Token (PAT)');
  console.log('   Get from: https://airtable.com/create/tokens');
  console.log('   Required scopes: data.records:read, data.records:write\n');
  
  const pat = await question('Enter your Airtable PAT: ');
  if (!pat || pat === 'your_personal_access_token_here') {
    console.log('‚ùå PAT is required! Please get your token from https://airtable.com/create/tokens');
    rl.close();
    return;
  }

  // Get Base ID
  console.log('\n2. Base ID (optional - you can also provide this in your code)');
  console.log('   Format: appXXXXXXXXXXXXXX');
  console.log('   Find in your Airtable base URL\n');
  
  const baseId = await question('Enter your Base ID (optional): ');

  // Generate .env.local content
  let envContent = ENV_TEMPLATE
    .replace('{{PAT}}', pat)
    .replace('{{BASE_ID}}', baseId || 'your_base_id_here');

  // Write file
  try {
    fs.writeFileSync(envPath, envContent);
    console.log('\n‚úÖ Success! Created .env.local file');
    console.log('\nüéØ Next steps:');
    console.log('1. Add .env.local to your .gitignore (should already be there in Next.js)');
    console.log('2. Test the integration with the demo component:');
    console.log('   import { AirtableDemo } from "@/components/examples/airtable-demo";');
    console.log('3. Start building with the Airtable hooks and client:');
    console.log('   import { useAirtable, createAirtableClient } from "@/lib/airtable";');
    console.log('\nüìñ See AIRTABLE_INTEGRATION.md for complete documentation');
    
    if (baseId) {
      console.log(`\nüîó Your integration is ready for base: ${baseId}`);
    } else {
      console.log('\nüí° You can provide the Base ID later via the baseId parameter in your code');
    }
    
  } catch (error) {
    console.log('‚ùå Failed to create .env.local file:', error.message);
  }

  rl.close();
}

if (require.main === module) {
  main().catch(console.error);
}

module.exports = { ENV_TEMPLATE };
